---
import { ViewTransitions } from "astro:transitions";
import "../styles/global.css";
import SchemaMarkup from "../components/SchemaMarkup.astro";

interface Props {
	title: string;
	description?: string;
	image?: string;
	type?: string;
}

const {
	title,
	description = "Assistência Técnica Premium Especializada em Salvador. Troca de tela, bateria e reparos em celulares e tablets Multimarcas em 40 minutos.",
	image = "/og-image.jpg",
	type = "website",
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageURL = new URL(image, Astro.site);
const base = import.meta.env.BASE_URL;
---

<!doctype html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href={`${base}logo-oficial.png`} />
		<meta name="generator" content={Astro.generator} />
		<link rel="canonical" href={canonicalURL} />
		<title>{title} | O Rei da Tela</title>

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={`${title} | O Rei da Tela`} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={imageURL} />
		<meta property="og:site_name" content="O Rei da Tela" />
		<meta property="og:locale" content="pt_BR" />

		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalURL} />
		<meta name="twitter:title" content={`${title} | O Rei da Tela`} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={imageURL} />

		<!-- Schema Markup -->
		<SchemaMarkup type="LocalBusiness" />

		<!-- DNS Prefetch for third-party domains -->
		<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
		<link rel="dns-prefetch" href="https://fonts.gstatic.com" />
		<link rel="dns-prefetch" href="https://www.googletagmanager.com" />
		<link rel="dns-prefetch" href="https://connect.facebook.net" />

		<!-- Preload Critical Resources (Desktop only for hero image) -->
		<link
			rel="preload"
			href="/images/hero-bg.webp"
			as="image"
			type="image/webp"
			media="(min-width: 768px)"
		/>
		<link
			rel="preload"
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&display=swap"
			as="style"
		/>

		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
			rel="stylesheet"
			media="print"
			onload="this.media='all'"
		/>
		<noscript>
			<link
				href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
				rel="stylesheet"
			/>
		</noscript>

		<ViewTransitions />

		<!-- Deferred Third-Party Scripts -->
		<script is:inline>
			// Defer GTM and Meta Pixel to improve LCP and TBT
			if (typeof window !== "undefined") {
				window.addEventListener("load", function () {
					setTimeout(function () {
						// Google Tag Manager
						(function (w, d, s, l, i) {
							w[l] = w[l] || [];
							w[l].push({
								"gtm.start": new Date().getTime(),
								event: "gtm.js",
							});
							var f = d.getElementsByTagName(s)[0],
								j = d.createElement(s),
								dl = l != "dataLayer" ? "&l=" + l : "";
							j.async = true;
							j.src =
								"https://www.googletagmanager.com/gtm.js?id=" +
								i +
								dl;
							f.parentNode.insertBefore(j, f);
						})(
							window,
							document,
							"script",
							"dataLayer",
							"GTM-NM6HFXBJ",
						);
					}, 2500); // Delay 2.5s after load to prioritize LCP
				});
			}
		</script>

		<script>
			document.addEventListener("astro:page-load", () => {
				// Google Tag Manager Page View for SPA transitions
				if ((window as any).dataLayer) {
					(window as any).dataLayer.push({
						event: "page_view",
						page_path: window.location.pathname,
						page_title: document.title,
					});
				}

				// WhatsApp Click Tracking
				const trackWhatsAppClick = (href: string) => {
					// GTM Event only - Tags inside GTM will handle GA4/Ads/Meta
					if ((window as any).dataLayer) {
						(window as any).dataLayer.push({
							event: "whatsapp_click",
							whatsapp_url: href,
						});
					}
				};

				// Delegate click events for all WhatsApp links
				document.addEventListener("click", (e) => {
					const el = e.target as HTMLElement;
					const target = el?.closest(
						'a[href*="wa.me"]',
					) as HTMLAnchorElement;
					if (target) {
						trackWhatsAppClick(target.href);
					}
				});
			});
		</script>
	</head>
	<body
		class="font-sans antialiased bg-white text-gray-900 overflow-x-hidden"
	>
		<!-- Google Tag Manager (noscript) -->
		<noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=GTM-NM6HFXBJ"
				height="0"
				width="0"
				style="display:none;visibility:hidden"></iframe></noscript
		>
		<!-- End Google Tag Manager (noscript) -->
		<slot />
		<style is:global>
			:root {
				--brand-navy: #1b365d;
				--brand-gold: #c5a059;
			}
			html {
				font-family: "Poppins", sans-serif;
				scroll-behavior: smooth;
			}
			body {
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
		</style>
	</body>
</html>
