---
import { ViewTransitions } from "astro:transitions";
import "../styles/global.css";

interface Props {
	title: string;
	description?: string;
}

const {
	title,
	description = "Assistência Técnica Apple Especializada em Salvador. Troca de tela, bateria e reparos em iPhone, Apple Watch e iPad em 40 minutos.",
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const base = import.meta.env.BASE_URL;
---

<!doctype html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
		<meta name="generator" content={Astro.generator} />
		<link rel="canonical" href={canonicalURL} />
		<title>{title} | O Rei da Tela</title>

		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
			rel="stylesheet"
		/>

		<ViewTransitions />

		<!-- Google Tag Manager -->
		<script is:inline>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({
					"gtm.start": new Date().getTime(),
					event: "gtm.js",
				});
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-NM6HFXBJ");
		</script>
		<!-- End Google Tag Manager -->

		<!-- Meta Pixel Code -->
		<script is:inline>
			!(function (f, b, e, v, n, t, s) {
				if (f.fbq) return;
				n = f.fbq = function () {
					n.callMethod
						? n.callMethod.apply(n, arguments)
						: n.queue.push(arguments);
				};
				if (!f._fbq) f._fbq = n;
				n.push = n;
				n.loaded = !0;
				n.version = "2.0";
				n.queue = [];
				t = b.createElement(e);
				t.async = !0;
				t.src = v;
				s = b.getElementsByTagName(e)[0];
				s.parentNode.insertBefore(t, s);
			})(
				window,
				document,
				"script",
				"https://connect.facebook.net/en_US/fbevents.js",
			);
			fbq("init", "1760266904626494");
			fbq("track", "PageView");
		</script>
		<noscript>
			<img
				height="1"
				width="1"
				style="display:none"
				src="https://www.facebook.com/tr?id=1760266904626494&ev=PageView&noscript=1"
			/>
		</noscript>
		<!-- End Meta Pixel Code -->

		<script>
			document.addEventListener("astro:page-load", () => {
				// Google Tag Manager Page View for SPA transitions
				if ((window as any).dataLayer) {
					(window as any).dataLayer.push({
						event: "page_view",
						page_path: window.location.pathname,
						page_title: document.title,
					});
				}

				// WhatsApp Click Tracking
				const trackWhatsAppClick = (href: string) => {
					// GA4 Event (if gtag is available)
					if (typeof (window as any).gtag === "function") {
						(window as any).gtag("event", "whatsapp_contact", {
							event_category: "conversion",
							event_label: href,
							value: 1,
						});
					}

					// Meta Pixel Event
					if (typeof (window as any).fbq === "function") {
						(window as any).fbq("track", "Contact", {
							content_name: "WhatsApp Redirect",
							content_category: "Lead",
						});
					}

					// GTM Event
					if ((window as any).dataLayer) {
						(window as any).dataLayer.push({
							event: "whatsapp_click",
							whatsapp_url: href,
						});
					}
				};

				// Delegate click events for all WhatsApp links
				document.addEventListener("click", (e) => {
					const el = e.target as HTMLElement;
					const target = el?.closest(
						'a[href*="wa.me"]',
					) as HTMLAnchorElement;
					if (target) {
						trackWhatsAppClick(target.href);
					}
				});
			});
		</script>
	</head>
	<body
		class="font-sans antialiased bg-white text-gray-900 overflow-x-hidden"
	>
		<!-- Google Tag Manager (noscript) -->
		<noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=GTM-NM6HFXBJ"
				height="0"
				width="0"
				style="display:none;visibility:hidden"></iframe></noscript
		>
		<!-- End Google Tag Manager (noscript) -->
		<slot />
		<style is:global>
			:root {
				--brand-navy: #1b365d;
				--brand-gold: #c5a059;
			}
			html {
				font-family: "Poppins", sans-serif;
				scroll-behavior: smooth;
			}
			body {
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
		</style>
	</body>
</html>
